# AIM: Read in my raw data and rearrange and summarise so that it looks like the format that FSS GAM runs with.
# The data needs to be arranged so that each site appears only once in each row of data, with the species/maxn values arranged in each column (i.e. site by feature matrix)


# For example, the data format that FSS GAM runs with looks a bit like this.

# ------------------------------
# Rows: 285
# Columns: 27
# $ X.1         <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 2...
# $ X           <int> 1, 2, 3, 4, 5, 6, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, ...
# $ sediment    <dbl> -3.26250047, -3.48382800, -4.68556024, -3.24865363, -3.43280045, -3.61029675, -4...
# $ Location    <chr> "Hahei", "Hahei", "Hahei", "Hahei", "Hahei", "Hahei", "Hahei", "Hahei", "Hahei",...
# $ Status      <chr> "Fished", "Fished", "Fished", "Fished", "Fished", "Fished", "Fished", "Fished", ...
# $ Site        <chr> "Cooks Beach Inner", "Cooks Beach Inner", "Cooks Beach Inner", "Cooks Beach Inne...
# $ Distance    <int> 2, 5, 15, 30, 2, 5, 30, 2, 5, 15, 30, 2, 5, 15, 30, 2, 5, 15, 30, 2, 5, 15, 30, ...
# $ depth       <int> 12, 12, 12, 12, 9, 9, 9, 10, 10, 12, 12, 10, 10, 11, 11, 11, 10, 11, 10, 10, 10,...
# $ X4mm        <dbl> 3.16462, 1.69129, 1.67228, 0.79670, 0.03768, 0.23887, 0.05118, 0.28782, 0.02412,...
# $ X2mm        <dbl> 1.41119, 1.62811, 1.01193, 0.77126, 0.25556, 0.57024, 0.41971, 0.61595, 0.36928,...
# $ X1mm        <dbl> 3.88962, 4.86726, 3.97180, 1.82919, 2.09768, 3.42348, 2.96787, 4.71152, 3.84234,...
# $ X500um      <dbl> 8.69694, 9.92831, 21.37884, 7.81927, 15.76419, 18.22572, 19.90608, 28.53734, 35....
# $ X250um      <dbl> 70.31984, 69.18594, 64.74207, 78.20548, 67.41767, 62.77750, 70.82593, 41.75500, ...
# $ X125um      <dbl> 6.19663, 5.70317, 2.75041, 5.26789, 7.21756, 7.48086, 2.31633, 21.44334, 11.8824...
# $ X63um       <dbl> 6.25038, 6.92941, 4.42267, 5.27693, 7.08857, 7.17101, 3.47006, 2.59654, 0.94092,...
# $ fetch       <dbl> 2232582.5, 2232582.5, 2232582.5, 2232582.5, 1027166.9, 1027166.9, 1027166.9, 292...
# $ org         <dbl> 3.45785, 3.19104, 2.80046, 2.78881, 2.47510, 2.52552, 2.30917, 0.89349, 2.53218,...
# $ snapper     <dbl> 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, ...
# $ lobster     <dbl> 0.0, 0.0, 0.0, 0.0, 0.2, 0.2, 0.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 5.2, ...
# $ InPreds     <dbl> 0.0000000, 0.0000000, 0.0000000, 0.3333333, 0.0000000, 1.0000000, 0.0000000, 0.3...
# $ BioTurb     <dbl> 0.1666667, 0.1666667, 0.8333333, 0.3333333, 0.3333333, 0.1666667, 0.3333333, 0.1...
# $ Taxa        <chr> "BDS", "BDS", "BDS", "BDS", "BDS", "BDS", "BDS", "BDS", "BDS", "BDS", "BDS", "BD...
# $ response    <int> 0, 1, 0, 1, 6, 5, 1, 0, 0, 0, 0, 0, 0, 1, 3, 0, 4, 0, 2, 0, 0, 0, 0, 0, 0, 0, 1,...
# $ sqrt.X4mm   <dbl> 1.7789379, 1.3004961, 1.2931667, 0.8925805, 0.1941134, 0.4887433, 0.2262300, 0.5...
# $ sqrt.X2mm   <dbl> 1.1879352, 1.2759741, 1.0059473, 0.8782141, 0.5055294, 0.7551424, 0.6478503, 0.7...
# $ sqrt.X1mm   <dbl> 1.9722120, 2.2061868, 1.9929375, 1.3524755, 1.4483370, 1.8502648, 1.7227507, 2.1...
# $ sqrt.X500um <dbl> 2.9490575, 3.1509221, ...
#-------------------------------------------

library(tidyverse)
raw_dat <- read_rds("E:/stats/aldabra/BRUVs/01_prep_data/04_size_classes_2_from_chapter_4/fish.df4.rds")

# OK, so running the script below calls a script from my PhD - which will prepare such a data set from my raw data.
source("E:/stats/aldabra/BRUVs/02_ALD/diversity/scripts/01_read_reshape_sp_comm_matrices.R")
# It represents mean maxn for each species, from the paired samples RUVS and BRUVs from the same sampling area.

# Clear up the data that we don't need right away - keeping only ald.paired
rm(bruvs.comm.ald.paired,ruvs.comm.ald.paired, fish.df4,nsp.ald.paired, raw_dat, comm.ald.paired)

# now, reshape (into a species by site matrix)
dat <- reshape2::acast(ald.paired, opcode ~ species, fill = 0, value.var = 'maxn', fun.aggregate = sum)

dat_df <- as_tibble(dat)

#  add opcode as a column, to which env data can be joined
dat_df$opcode <- rownames(dat)

# join the env data that you are interested in
dat_long <- dat_df %>% pivot_longer(!opcode, names_to = "Taxa", values_to = "response")

# now join env data
dat_df_species_env <- ald.paired %>% select(
  opcode,
  treatment,
  depth,
  rugosity,
  sample_area = sample.area,
  temperature,
  we2_mean,
  f_effort,
  perc_water_column,
  has_score,
  treatment.partner
) %>% 
  distinct() %>% 
  right_join(dat_long, by = "opcode")

# That should provide a comparable data set that can be explored.
# Discuss with Ant:
#  What needs adding: a variable to work out aspect in terms of continuous 360 deg?; 
# Any transformations to add? See the Standardising transformations already applied in earlier chapters
rm(dat,dat_df)
# simplify data naming for easier coding
dat <- dat_df_species_env
rm(dat_df_species_env)

